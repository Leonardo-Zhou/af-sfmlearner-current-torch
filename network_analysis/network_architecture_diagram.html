<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SfM Learner 网络架构图</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content {
            padding: 30px;
        }
        .diagram-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .network-section {
            margin: 30px 0;
            padding: 20px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            border-radius: 5px;
        }
        h1, h2 {
            margin: 0 0 15px 0;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .legend-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .color-box {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 10px;
            border-radius: 3px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 SfM Learner 网络架构可视化</h1>
            <p>完整的网络数据流与架构图</p>
        </div>
        
        <div class="content">
            <div class="network-section">
                <h2>📊 1. 整体网络架构（含Spatial Transformer）</h2>
                <div class="diagram-container">
                    <div class="mermaid">
                        graph TD
                            subgraph "SfM Learner 完整系统架构"
                                A["输入图像<br/>[B, 3×N, H, W]"] --> B["ResNetEncoder"]
                                B --> C["多尺度特征"]
                                C --> D["DepthDecoder"]
                                C --> E["PoseDecoder"]
                                C --> F["PositionDecoder"]
                                C --> G["TransformDecoder"]
                                
                                D --> H["深度图<br/>4个尺度"]
                                E --> I["姿态参数<br/>轴角+平移"]
                                F --> J["光流场<br/>4个尺度"]
                                G --> K["外观流<br/>4个尺度"]
                                
                                subgraph "Spatial Transformer 核心连接"
                                ST_Depth["Spatial Transformer<br/>深度投影"]
                                ST_Flow["Spatial Transformer<br/>光流重建"]
                                ST_App["Spatial Transformer<br/>外观变换"]
                            end
                            
                            H --> ST_Depth
                            I --> ST_Depth
                            J --> ST_Flow
                            K --> ST_App
                            
                            ST_Depth --> Synthesis["合成图像<br/>[B,3×(N-1),H,W]"]
                            ST_Flow --> Synthesis
                            ST_App --> Synthesis
                            
                            Synthesis --> Loss["光度一致性损失"]
                            A --> Loss
                            end
                            
                            style A fill:#ff6b6b,stroke:#c92a2a,color:#fff
                            style B fill:#4ecdc4,stroke:#2b8a9e,color:#fff
                            style C fill:#45b7d1,stroke:#1864ab,color:#fff
                            style D fill:#96ceb4,stroke:#2d6a4f,color:#fff
                            style E fill:#ffeaa7,stroke:#e17055,color:#000
                            style F fill:#dda0dd,stroke:#8b008b,color:#fff
                            style G fill:#98d8c8,stroke:#2d6a4f,color:#000
                            style H fill:#f7dc6f,stroke:#b8860b,color:#000
                            style I fill:#bb8fce,stroke:#8e44ad,color:#fff
                            style J fill:#85c1e9,stroke:#2874a6,color:#fff
                            style K fill:#82e0aa,stroke:#239b56,color:#000
                            style ST_Depth fill:#f9ca24,stroke:#b8860b,color:#000
                            style ST_Flow fill:#f9ca24,stroke:#b8860b,color:#000
                            style ST_App fill:#f9ca24,stroke:#b8860b,color:#000
                            style Synthesis fill:#6c5ce7,stroke:#4834d4,color:#fff
                            style Loss fill:#ff6b6b,stroke:#c92a2a,color:#fff
                    </div>
                </div>
            </div>

            <div class="network-section">
                <h2>🏗️ 2. ResNetEncoder 详细结构</h2>
                <div class="diagram-container">
                    <div class="mermaid">
                        graph TD
                            subgraph "ResNetEncoder-18 详细结构"
                                A1["输入<br/>[B,3×N,H,W]"] --> B1["Conv1<br/>[B,64,H/2,W/2]<br/>7×7, stride=2"]
                                B1 --> C1["BatchNorm+ReLU"] 
                                C1 --> D1["MaxPool<br/>[B,64,H/4,W/4]<br/>3×3, stride=2"]
                                
                                D1 --> E1["Layer1<br/>[B,64,H/4,W/4]<br/>BasicBlock×2"]
                                E1 --> F1["Layer2<br/>[B,128,H/8,W/8]<br/>BasicBlock×2<br/>stride=2"]
                                F1 --> G1["Layer3<br/>[B,256,H/16,W/16]<br/>BasicBlock×2<br/>stride=2"]
                                G1 --> H1["Layer4<br/>[B,512,H/32,W/32]<br/>BasicBlock×2<br/>stride=2"]
                                
                                E1 --> I1["特征0<br/>[B,64,H/4,W/4]"]
                                F1 --> J1["特征1<br/>[B,128,H/8,W/8]"]
                                G1 --> K1["特征2<br/>[B,256,H/16,W/16]"]
                                H1 --> L1["特征3<br/>[B,512,H/32,W/32]"]
                                H1 --> M1["特征4<br/>[B,512,H/32,W/32]"]
                            end
                            
                            subgraph "BasicBlock结构"
                                BB1["输入x"] --> BB2["Conv3×3<br/>BatchNorm<br/>ReLU"]
                                BB2 --> BB3["Conv3×3<br/>BatchNorm"]
                                BB3 --> BB4["+ x<br/>ReLU"]
                                BB4 --> BB5["输出"]
                            end
                            
                            style A1 fill:#ff6b6b,stroke:#c92a2a,color:#fff
                            style B1 fill:#4ecdc4,stroke:#2b8a9e,color:#fff
                            style D1 fill:#45b7d1,stroke:#1864ab,color:#fff
                            style E1 fill:#96ceb4,stroke:#2d6a4f,color:#fff
                            style F1 fill:#ffeaa7,stroke:#e17055,color:#000
                            style G1 fill:#dda0dd,stroke:#8b008b,color:#fff
                            style H1 fill:#98d8c8,stroke:#2d6a4f,color:#000
                            style I1 fill:#f7dc6f,stroke:#b8860b,color:#000
                            style J1 fill:#bb8fce,stroke:#8e44ad,color:#fff
                            style K1 fill:#85c1e9,stroke:#2874a6,color:#fff
                            style L1 fill:#82e0aa,stroke:#239b56,color:#000
                            style M1 fill:#f8c471,stroke:#b8860b,color:#000
                    </div>
                </div>
            </div>

            <div class="network-section">
                <h2>🔍 3. DepthDecoder U-Net架构</h2>
                <div class="diagram-container">
                    <div class="mermaid">
                        graph TD
                            subgraph "DepthDecoder U-Net 详细维度"
                                A2["输入<br/>[B,512,H/32,W/32]"] --> B2["Conv0<br/>[B,256,H/32,W/32]<br/>Conv3×3+ReLU"]
                                B2 --> C2["Upsample<br/>[B,256,H/16,W/16]<br/>nearest×2"]
                                C2 --> D2["Concat<br/>[B,512,H/16,W/16]<br/>+ skip连接"]
                                D2 --> E2["Conv1<br/>[B,256,H/16,W/16]<br/>Conv3×3+ReLU"]
                                
                                E2 --> F2["Conv2<br/>[B,128,H/16,W/16]<br/>Conv3×3+ReLU"]
                                F2 --> G2["Upsample<br/>[B,128,H/8,W/8]<br/>nearest×2"]
                                G2 --> H2["Concat<br/>[B,256,H/8,W/8]<br/>+ skip连接"]
                                H2 --> I2["Conv3<br/>[B,128,H/8,W/8]<br/>Conv3×3+ReLU"]
                                
                                I2 --> J2["Conv4<br/>[B,64,H/8,W/8]<br/>Conv3×3+ReLU"]
                                J2 --> K2["Upsample<br/>[B,64,H/4,W/4]<br/>nearest×2"]
                                K2 --> L2["Concat<br/>[B,128,H/4,W/4]<br/>+ skip连接"]
                                L2 --> M2["Conv5<br/>[B,64,H/4,W/4]<br/>Conv3×3+ReLU"]
                                
                                M2 --> N2["Conv6<br/>[B,32,H/4,W/4]<br/>Conv3×3+ReLU"]
                                N2 --> O2["Upsample<br/>[B,32,H/2,W/2]<br/>nearest×2"]
                                O2 --> P2["Concat<br/>[B,96,H/2,W/2]<br/>+ skip连接"]
                                P2 --> Q2["Conv7<br/>[B,32,H/2,W/2]<br/>Conv3×3+ReLU"]
                                
                                Q2 --> R2["Conv8<br/>[B,16,H/2,W/2]<br/>Conv3×3+ReLU"]
                                R2 --> S2["Upsample<br/>[B,16,H,W]<br/>nearest×2"]
                                S2 --> T2["Conv9<br/>[B,16,H,W]<br/>Conv3×3+ReLU"]
                                
                                T2 --> U2["DispConv<br/>[B,1,H,W]<br/>Sigmoid激活"]
                                
                                T2 --> V2["DispConv_s1<br/>[B,1,H/2,W/2]<br/>Sigmoid激活"]
                                T2 --> W2["DispConv_s2<br/>[B,1,H/4,W/4]<br/>Sigmoid激活"]
                                T2 --> X2["DispConv_s3<br/>[B,1,H/8,W/8]<br/>Sigmoid激活"]
                            end
                            
                            subgraph "跳跃连接 - 与ResNetEncoder统一颜色"
                                S3["特征3<br/>[B,256,H/16,W/16]<br/>来自ResNet Layer3"] --> D2
                                S4["特征2<br/>[B,128,H/8,W/8]<br/>来自ResNet Layer2"] --> H2
                                S5["特征1<br/>[B,64,H/4,W/4]<br/>来自ResNet Layer1"] --> L2
                                S6["特征0<br/>[B,64,H/2,W/2]<br/>来自ResNet Conv1"] --> P2
                            end
                            
                            style A2 fill:#ff6b6b,stroke:#c92a2a,color:#fff
                            style U2 fill:#4ecdc4,stroke:#2b8a9e,color:#fff
                            style V2 fill:#45b7d1,stroke:#1864ab,color:#fff
                            style W2 fill:#96ceb4,stroke:#2d6a4f,color:#fff
                            style X2 fill:#ffeaa7,stroke:#e17055,color:#000
                            style S3 fill:#dda0dd,stroke:#8b008b,color:#fff
                            style S4 fill:#85c1e9,stroke:#2874a6,color:#fff
                            style S5 fill:#82e0aa,stroke:#239b56,color:#000
                            style S6 fill:#f8c471,stroke:#b8860b,color:#000
                    </div>
                </div>
            </div>

            <div class="network-section">
                <h2>🎯 4. PoseDecoder 架构 (贪吃蛇式布局)</h2>
                <div class="diagram-container">
                    <div class="mermaid">
                        graph LR
                            subgraph "PoseDecoder 贪吃蛇式布局"
                                A3["输入特征<br/>[B,512,H/32,W/32]"] --> B3["Squeeze<br/>[B,256,H/32,W/32]<br/>1×1 Conv, ReLU"]
                                B3 --> C3["Concat<br/>[B,256×N,H/32,W/32]<br/>多帧特征拼接"]
                                C3 --> D3["Pose_0<br/>[B,256,H/32,W/32]<br/>3×3 Conv, ReLU"]
                                D3 --> E3["Pose_1<br/>[B,256,H/32,W/32]<br/>3×3 Conv, ReLU"]
                                E3 --> F3["Pose_2<br/>[B,6×(N-1),H/32,W/32]<br/>1×1 Conv"]
                                F3 --> G3["GlobalAvgPool<br/>[B,6×(N-1),1,1]<br/>空间维度平均"]
                                G3 --> H3["Reshape<br/>[B,N-1,1,6]<br/>姿态参数"]
                                H3 --> I3["Split<br/>[B,N-1,1,3] + [B,N-1,1,3]<br/>axisangle + translation"]
                            end
                    </div>
                </div>
            </div>

            <div class="network-section">
                <h2>🔄 5. Spatial Transformer 工作流程</h2>
                <div class="diagram-container">
                    <div class="mermaid">
                        graph TD
                            subgraph "Spatial Transformer 在SfM Learner中的完整应用"
                                
                                subgraph "1. 深度投影应用"
                                    Depth_Input["深度图<br/>[B,1,H,W]"] --> Depth_3D["BackprojectDepth<br/>3D点云"]
                                    Pose_Input["姿态参数<br/>[B,6]"] --> Depth_Extrinsic["相机外参矩阵"]
                                    Depth_3D --> Depth_Project["Project3D<br/>2D投影"]
                                    Depth_Extrinsic --> Depth_Project
                                    Depth_Project --> Depth_ST["SpatialTransformer<br/>深度投影"]
                                    Source_Img["源图像<br/>[B,3,H,W]"] --> Depth_ST
                                    Depth_ST --> Depth_Output["合成图像<br/>[B,3,H,W]"]
                                end
                                
                                subgraph "2. 光流重建应用"
                                    Flow_Input["光流场<br/>[B,2,H,W]"] --> Flow_Grid["生成采样网格<br/>[B,H,W,2]"]
                                    Target_Img["目标图像<br/>[B,3,H,W]"] --> Flow_ST["SpatialTransformer<br/>光流重建"]
                                    Flow_Grid --> Flow_ST
                                    Flow_ST --> Flow_Output["变形图像<br/>[B,3,H,W]"]
                                end
                                
                                subgraph "3. 外观变换应用"
                                    App_Input["外观流<br/>[B,3,H,W]"] --> App_ST["SpatialTransformer<br/>外观变换"]
                                    Source_App["源图像<br/>[B,3,H,W]"] --> App_ST
                                    App_ST --> App_Output["变换图像<br/>[B,3,H,W]"]
                                end
                                
                                subgraph "4. 多尺度统一应用"
                                    Scale0["Scale 0<br/>[B,3,H,W]"] --> ST0["ST@Scale0"]
                                    Scale1["Scale 1<br/>[B,3,H/2,W/2]"] --> ST1["ST@Scale1"]
                                    Scale2["Scale 2<br/>[B,3,H/4,W/4]"] --> ST2["ST@Scale2"]
                                    Scale3["Scale 3<br/>[B,3,H/8,W/8]"] --> ST3["ST@Scale3"]
                                end
                            end
                            
                            subgraph "技术实现细节"
                                IMPL["layers.py<br/>SpatialTransformer类"] --> METHOD["forward()方法"]
                                METHOD --> GRID["生成采样网格<br/>meshgrid + flow"]
                                GRID --> SAMPLE["grid_sample()<br/>双线性插值"]
                                SAMPLE --> OUTPUT["输出变换后图像"]
                            end
                            
                            style Depth_Input fill:#45b7d1,stroke:#2c3e50,color:#fff
                            style Flow_Input fill:#ffeaa7,stroke:#d35400,color:#000
                            style App_Input fill:#dda0dd,stroke:#8b008b,color:#fff
                            style Depth_ST fill:#f9ca24,stroke:#b8860b,color:#000
                            style Flow_ST fill:#f9ca24,stroke:#b8860b,color:#000
                            style App_ST fill:#f9ca24,stroke:#b8860b,color:#000
                    </div>
                </div>
            </div>

            <div class="network-section">
                <h2>📈 6. 多尺度输出结构</h2>
                <div class="diagram-container">
                    <div class="mermaid">
                        graph TD
                            subgraph "多尺度输出 (Scale 0-3)"
                                MS0["Scale 0<br/>Full Resolution<br/>DispConv_s0<br/>[B,1,H,W]"]
                                MS1["Scale 1<br/>Half Resolution<br/>DispConv_s1<br/>[B,1,H/2,W/2]"]
                                MS2["Scale 2<br/>Quarter Resolution<br/>DispConv_s2<br/>[B,1,H/4,W/4]"]
                                MS3["Scale 3<br/>Eighth Resolution<br/>DispConv_s3<br/>[B,1,H/8,W/8]"]
                                
                                subgraph "Spatial Transformer 应用"
                                    ST_APP1["Scale 0<br/>ST: [B,3,H,W] → [B,3,H,W]"]
                                    ST_APP2["Scale 1<br/>ST: [B,3,H/2,W/2] → [B,3,H/2,W/2]"]
                                    ST_APP3["Scale 2<br/>ST: [B,3,H/4,W/4] → [B,3,H/4,W/4]"]
                                    ST_APP4["Scale 3<br/>ST: [B,3,H/8,W/8] → [B,3,H/8,W/8]"]
                                end
                            end
                            
                            subgraph "光流输出"
                                OF0["Scale 0<br/>Optical Flow<br/>[B,2,H,W]"]
                                OF1["Scale 1<br/>Optical Flow<br/>[B,2,H/2,W/2]"]
                                OF2["Scale 2<br/>Optical Flow<br/>[B,2,H/4,W/4]"]
                                OF3["Scale 3<br/>Optical Flow<br/>[B,2,H/8,W/8]"]
                            end
                    </div>
                </div>
            </div>

            <div class="network-section">
                <h2>🎨 7. 颜色图例与统一标准</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #ff6b6b;"></div>
                        <span>输入层 (Input)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #4ecdc4;"></div>
                        <span>输出层 (Output)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #45b7d1;"></div>
                        <span>卷积层 (Conv)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #96ceb4;"></div>
                        <span>跳跃连接 (Skip Connection)<br/><small>与ResNetEncoder特征图颜色一致</small></span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #ffeaa7;"></div>
                        <span>上采样 (Upsample)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #dda0dd;"></div>
                        <span>池化层 (Pooling)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #f9ca24;"></div>
                        <span>Spatial Transformer</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #6c5ce7;"></div>
                        <span>ResNet特征图</span>
                    </div>
                </div>
            </div>

            <div class="network-section">
                <h2>📊 8. 参数对比表</h2>
                <div class="diagram-container">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #007bff; color: white;">
                                <th style="padding: 12px; text-align: left;">网络组件</th>
                                <th style="padding: 12px; text-align: left;">输入尺寸</th>
                                <th style="padding: 12px; text-align: left;">输出尺寸</th>
                                <th style="padding: 12px; text-align: left;">参数量</th>
                                <th style="padding: 12px; text-align: left;">计算复杂度</th>
                                <th style="padding: 12px; text-align: left;">主要用途</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 12px;">ResNetEncoder-18</td>
                                <td style="padding: 12px;">[B,3×N,H,W]</td>
                                <td style="padding: 12px;">5个尺度特征</td>
                                <td style="padding: 12px;">11.2M</td>
                                <td style="padding: 12px;">O(H×W×C)</td>
                                <td style="padding: 12px;">特征提取</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 12px;">DepthDecoder</td>
                                <td style="padding: 12px;">5个尺度特征</td>
                                <td style="padding: 12px;">4尺度深度图</td>
                                <td style="padding: 12px;">~1.5M</td>
                                <td style="padding: 12px;">O(H×W×C)</td>
                                <td style="padding: 12px;">深度估计</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 12px;">PoseDecoder</td>
                                <td style="padding: 12px;">[B,512×N,H/32,W/32]</td>
                                <td style="padding: 12px;">[B,N-1,1,6]</td>
                                <td style="padding: 12px;">~0.3M</td>
                                <td style="padding: 12px;">O(H/32×W/32×C)</td>
                                <td style="padding: 12px;">姿态估计</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 12px;">PositionDecoder</td>
                                <td style="padding: 12px;">5个尺度特征</td>
                                <td style="padding: 12px;">4尺度光流</td>
                                <td style="padding: 12px;">~1.5M</td>
                                <td style="padding: 12px;">O(H×W×C)</td>
                                <td style="padding: 12px;">光流估计</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 12px;">TransformDecoder</td>
                                <td style="padding: 12px;">5个尺度特征</td>
                                <td style="padding: 12px;">4尺度外观流</td>
                                <td style="padding: 12px;">~1.5M</td>
                                <td style="padding: 12px;">O(H×W×C)</td>
                                <td style="padding: 12px;">外观变换</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 12px;">SpatialTransformer</td>
                                <td style="padding: 12px;">[B,3,H,W] + [B,2,H,W]</td>
                                <td style="padding: 12px;">[B,3,H,W]</td>
                                <td style="padding: 12px;">0.0M</td>
                                <td style="padding: 12px;">O(H×W×C)</td>
                                <td style="padding: 12px;">空间变换</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });
    </script>
</body>
</html>